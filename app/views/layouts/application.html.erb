<!DOCTYPE html>
<html>
  <head>
    <title>Xuarani</title>
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <!-- Evita que Turbo y el navegador guarden vistas cacheadas -->
    <meta name="turbo-prefetch" content="false">
    <meta name="turbo-cache-control" content="no-cache">
    <meta name="turbo-drive" content="false">

    <!-- Archivos de Rails -->
    <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
    <%= javascript_importmap_tags %>

    <!-- Favicon -->
    <link rel="icon" href="<%= asset_path 'favicon/favicon.ico' %>" type="image/x-icon">

    <!-- Driver.js -->
    <script src="https://cdn.jsdelivr.net/npm/driver.js@latest/dist/driver.js.iife.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/driver.js@latest/dist/driver.css"/>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  </head>

  <body class="d-flex flex-column min-vh-100">
    <!-- NAVBAR segÃºn rol -->
    <% if user_signed_in? && current_user.has_role?(:administrador) %>
      <%= render "layouts/admin_navbar" %>
    <% elsif user_signed_in? && current_user.has_role?(:docente) %>
      <%= render "layouts/docente_navbar" %>
    <% elsif user_signed_in? %>
      <%= render "layouts/navbar" %> <!-- genÃ©rico para otros roles -->
    <% else %>
      <%= render "layouts/public_navbar" %>
    <% end %>

    <!-- Toast container (flotante arriba a la derecha) -->
    <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1100">
      <%= render "layouts/flash" %>
    </div>

    <!-- CONTENIDO PRINCIPAL -->
    <main class="<%= content_for?(:layout_container_class) ? yield(:layout_container_class) : 'container py-4' %> flex-grow-1">
      <%= yield %>
    </main>

    <!-- FOOTER -->
    <%= render "layouts/footer" %>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" defer></script>

    <!-- Script global: controla cache y limpia modales -->
    <script>
      // ðŸ”„ Forzar recarga si el usuario vuelve atrÃ¡s (previene vistas cacheadas y modales "pegados")
      window.addEventListener("pageshow", function (event) {
        if (event.persisted) {
          window.location.reload();
        }
      });

      // ðŸ§¹ Limpiar formularios y textos temporales de todos los modales al cerrarse
      document.addEventListener("DOMContentLoaded", () => {
        const modals = document.querySelectorAll(".modal");

        modals.forEach(modalEl => {
          modalEl.addEventListener("hidden.bs.modal", () => {
            // Limpia formularios dentro del modal
            modalEl.querySelectorAll("form").forEach(form => form.reset());

            // Limpia textos o valores temporales
            modalEl.querySelectorAll("input, textarea, strong").forEach(el => {
              if (el.tagName === "STRONG") {
                el.textContent = "";
              } else if (el.type !== "hidden") {
                el.value = "";
              }
            });
          });
        });
      });
    </script>
  </body>
</html>
