<div class="container">
  <h1 class="mb-4 text-center">Panel de Usuarios</h1>

  <!-- Botón crear nuevo usuario -->
  <div class="mb-3 text-end">
    <%= link_to "Nuevo Usuario", new_user_path, class: "btn btn-success" %>
  </div>

  <!-- Tabla principal -->
  <div class="card shadow-sm">
    <div class="card-body p-0">
      <div id="usersTable">
        <table class="table table-striped table-hover align-middle mb-0">
          <thead class="table-dark">
            <tr>
              <th>Email</th>
              <th>Nombre completo</th>
              <th>Roles</th>
              <th class="text-end">Acciones</th>
            </tr>
          </thead>
          <tbody>
            <% @users.each do |user| %>
              <!-- Fila principal -->
              <tr>
                <td><%= user.email %></td>
                <td><%= user.full_name.presence || "-" %></td>
                <td>
                  <% user.roles.each do |role| %>
                    <span class="badge <%= role_badge_class(role.nombre) %>">
                      <%= role.nombre %>
                    </span>
                  <% end %>
                </td>
                <td class="text-end">
                  <!-- Botón para desplegar detalles -->
                  <button class="btn btn-sm btn-outline-secondary" type="button"
                          data-bs-toggle="collapse" data-bs-target="#user_<%= user.id %>">
                    Ver
                  </button>

                  <!-- Botón editar -->
                  <%= link_to "Editar", edit_user_path(user), class: "btn btn-sm btn-outline-primary" %>

                  <!-- Botón eliminar (abre modal) -->
                  <button type="button"
                          class="btn btn-sm btn-outline-danger"
                          data-bs-toggle="modal"
                          data-bs-target="#confirmDeleteModal"
                          data-user-id="<%= user.id %>"
                          data-user-name="<%= user.full_name.presence || user.email %>">
                    Eliminar
                  </button>
                </td>
              </tr>

              <!-- Fila de detalles desplegable -->
              <tr class="p-0 border-0">
                <td colspan="4" class="p-0 border-0">
                  <div class="collapse fade" id="user_<%= user.id %>" data-bs-parent="#usersTable">
                    <div class="bg-light p-3 border-top">
                      <h6 class="fw-bold">Perfil</h6>
                      <% if user.perfil.present? %>
                        <p><strong>DNI:</strong> <%= user.dni %></p>
                        <p><strong>Fecha de nacimiento:</strong>
                          <%= l(user.fecha_nacimiento, format: :long) if user.fecha_nacimiento %>
                        </p>
                        <p><strong>Dirección:</strong> <%= user.direccion %></p>
                        <p><strong>Teléfono:</strong> <%= user.telefono %></p>
                      <% else %>
                        <span class="text-muted">No tiene perfil cargado</span>
                      <% end %>
                    </div>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Modal de confirmación de eliminación -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="confirmDeleteModalLabel">
          <i class="bi bi-exclamation-triangle-fill me-2"></i> Confirmar eliminación
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        ¿Estás seguro de que deseas eliminar a <strong id="userToDelete"></strong>?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <form id="deleteUserForm" method="post">
          <input type="hidden" name="_method" value="delete">
          <input type="hidden" name="authenticity_token" id="csrfToken">
          <button type="submit" class="btn btn-danger">Eliminar</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Script para configurar el modal dinámicamente -->
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const modal = document.getElementById("confirmDeleteModal");
    const userLabel = document.getElementById("userToDelete");
    const form = document.getElementById("deleteUserForm");
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute("content");
    document.getElementById("csrfToken").value = csrfToken;

    modal.addEventListener("show.bs.modal", (event) => {
      const button = event.relatedTarget;
      const userId = button.getAttribute("data-user-id");
      const userName = button.getAttribute("data-user-name") || "este usuario";

      userLabel.textContent = userName;
      form.action = `/users/${userId}`;
    });
  });
</script>